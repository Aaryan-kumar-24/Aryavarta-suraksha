{% include "header.html" %}

<style>
.center{text-align:center}

/* ===== CCTV ===== */
.cctvWrap{
  width:1100px;
  height:620px;
  margin:30px auto;
  position:relative;
}
.cctv{
  width:100%;height:100%;
  border-radius:18px;
  overflow:hidden;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(120,255,180,.25);
  backdrop-filter:blur(12px);
  animation:breatheFloatGreen 5s infinite;
}
.cctv:hover{animation:pulseSoftRed 1.2s infinite;}
.cctv img{width:100%;height:100%;object-fit:cover}

/* ===== MAIN GLASS CARD ===== */
.glass{
  max-width:1150px;
  margin:40px auto;
  padding:36px;
  border-radius:18px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(120,255,180,0.25);
  backdrop-filter:blur(12px);

  display:flex;
  gap:70px;
}

/* ===== LEFT PANEL ===== */
.left{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:26px;
}

/* ===== RIGHT PANEL ===== */
.right{
  flex:1.2;
  border-left:1px solid rgba(255,255,255,0.15);
  padding-left:36px;
}

/* ===== LARGE INPUT ===== */
.input-glass{
  width:320px;
  padding:16px 20px;
  border-radius:16px;
  border:1px solid rgba(120,255,180,0.35);
  background:rgba(255,255,255,0.08);
  color:white;
  font-size:1.1rem;
  outline:none;
  text-align:center;
  transition:.25s;
}
.input-glass:focus{
  border-color:#00ffb3;
  box-shadow:0 0 18px rgba(0,255,179,0.75);
  transform:scale(1.06);
}

/* ===== LARGE BUTTON ===== */
.btn{
  width:320px;
  padding:16px 20px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.1);
  color:white;
  cursor:pointer;
  font-size:1.1rem;
  font-weight:600;
  transition:.25s;
}
.btn:hover{animation:breatheRed 1.4s infinite}

/* ===== STACK ===== */
.stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:24px;
}

/* ===== ALERT LIST ===== */
ul{list-style:none;padding:0}
li{padding:10px 0;font-size:1rem}

/* ===== ANIMATIONS ===== */
@keyframes breatheFloatGreen{
0%{box-shadow:0 0 14px rgba(0,255,140,.35)}
50%{box-shadow:0 0 36px rgba(0,255,140,.8)}
100%{box-shadow:0 0 14px rgba(0,255,140,.35)}
}
@keyframes pulseSoftRed{
0%{box-shadow:0 0 20px rgba(255,60,60,.5)}
50%{box-shadow:0 0 45px rgba(255,40,40,1)}
100%{box-shadow:0 0 20px rgba(255,60,60,.5)}
}
@keyframes breatheRed{
0%{box-shadow:0 0 12px rgba(255,60,60,.5)}
50%{box-shadow:0 0 28px rgba(255,40,40,1)}
100%{box-shadow:0 0 12px rgba(255,60,60,.5)}
}
</style>

<div class="center"><h2 style="
text-align:center;
font-size:2.1rem;
font-weight:700;
margin-bottom:28px;
color:#7fe6ff;
animation:waitFlow 3s ease-in-out infinite;
">
‚è≥ Suspicious Waiting Detection ‚Ä¢ AI Behaviour Monitoring
</h2>

<style>
@keyframes waitFlow{
0%,100%{text-shadow:0 0 10px rgba(0,200,255,0.35); transform:translateY(0);}
50%{text-shadow:0 0 24px rgba(0,200,255,0.8); transform:translateY(-2px);}
}
</style>

<!-- CCTV -->
<div class="cctvWrap">
  <div class="cctv">
    <img id="liveVideo" src="/wait/stream/">
  </div>

  <div id="configMode" style="display:none;position:absolute;inset:0;">
    <img src="/wait/stream/" style="width:100%;height:100%;object-fit:cover">
    <canvas id="canvas" width="1100" height="620" style="position:absolute;inset:0"></canvas>
  </div>
</div>

<!-- SPLIT CARD -->
<div class="glass">

  <!-- LEFT -->
  <div class="left">

    <!-- DEFAULT -->
    <div id="defaultBtns" class="stack">
      <button class="btn" onclick="toggleConfig()">‚öô Configure Rectangle</button>
      <button class="btn" onclick="clearAll()">üóë Clear All</button>
      <button class="btn" onclick="resetDetection()">üîÑ Reset Detection</button>
    </div>

    <!-- CONFIG -->
    <div id="configBtns" class="stack" style="display:none;">
      <label>Threshold</label>
      <input id="globalThreshold" class="input-glass" type="number" value="1500">

      <label>Wait Time (seconds)</label>
      <input id="waitTime" class="input-glass" type="number" value="2">

      <button class="btn" onclick="updateConfig()">Update</button>
      <button class="btn" onclick="toggleConfig()">Close</button>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="right">
    <h3>Recent Waiting Alerts</h3>
    <ul id="alertList"></ul>
  </div>

</div>
</div>


<script>
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");

let boxes=[]; let bw=0.2; let bh=0.2;

async function loadConfig(){
 const r=await fetch("/wait/get-config/");
 const data=await r.json();

 boxes=data.boxes||[];
 bw=data.bw; bh=data.bh;

 document.getElementById("waitTime").value=data.wait_time;
 document.getElementById("globalThreshold").value=data.threshold||1500;

 draw();
}

async function toggleConfig(){
 let video=document.getElementById("liveVideo");
 let config=document.getElementById("configMode");
 let dBtns=document.getElementById("defaultBtns");
 let cBtns=document.getElementById("configBtns");

 if(config.style.display==="none"){
   await fetch("/wait/set-mode/",{
     method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({config:true})
   });

   video.style.visibility="hidden";
   config.style.display="block";
   dBtns.style.display="none";
   cBtns.style.display="flex";

   await loadConfig();

 }else{
   await fetch("/wait/set-mode/",{
     method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({config:false})
   });

   config.style.display="none";
   video.style.visibility="visible";
   dBtns.style.display="flex";
   cBtns.style.display="none";
 }
}

canvas.onclick=function(e){
 let rect=canvas.getBoundingClientRect();
 let x=(e.clientX-rect.left)/canvas.width;
 let y=(e.clientY-rect.top)/canvas.height;

 for(let i=0;i<boxes.length;i++){
   let b=boxes[i];
   if(x>b[0]&&x<b[0]+bw&&y>b[1]&&y<b[1]+bh){
     boxes.splice(i,1); draw(); return;
   }
 }
 boxes.push([x,y]); draw();
};

function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.strokeStyle="yellow";
 ctx.lineWidth=2;

 boxes.forEach(b=>{
   ctx.strokeRect(b[0]*canvas.width,b[1]*canvas.height,bw*canvas.width,bh*canvas.height);
 });
}

/* ===== UPDATE ‚Üí SAVE + RESET + CLOSE ===== */
function updateConfig(){
 fetch("/wait/config/",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({
     boxes:boxes,
     wait_time:document.getElementById("waitTime").value,
     threshold:document.getElementById("globalThreshold").value,
     bw:bw, bh:bh
   })
 })
 .then(()=>fetch("/wait/reset/",{method:"POST"}))
 .then(toggleConfig);
}

/* ‚úÖ FIXED CLEAR ALL (same as old working logic) */
function clearAll(){
 boxes = [];
 draw();

 fetch("/wait/config/",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({
     boxes:[],
     wait_time:document.getElementById("waitTime")?.value || 2,
     threshold:document.getElementById("globalThreshold")?.value || 1500,
     bw:bw,
     bh:bh
   })
 })
 .then(()=>fetch("/wait/reset/",{method:"POST"}));
}

function resetDetection(){
 fetch("/wait/reset/",{method:"POST"});
}

/* ===== 12-hour alert format ===== */
function to12Hour(t){
 let d=new Date("1970-01-01T"+t);
 return d.toLocaleTimeString([],{
   hour:"numeric",minute:"2-digit",second:"2-digit",hour12:true
 });
}

function loadAlerts(){
 fetch("/wait/data/")
 .then(r=>r.json())
 .then(data=>{
   let ul=document.getElementById("alertList");
   ul.innerHTML="";
   data.slice().reverse().forEach(t=>{
     let li=document.createElement("li");
     li.innerText="‚è∞ Wait alert at "+to12Hour(t);
     ul.appendChild(li);
   });
 });
}

setInterval(loadAlerts,2000);
loadConfig();
</script>

{% include "footer.html" %}
